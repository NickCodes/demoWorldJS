<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<link rel="stylesheet" type="text/css" href="assets/styles/main.css">
	</head>
  
	<body>
		<div id="3jsContainer" class="3jsContainer"></div>

		<script src="assets/lib/jquery-1.11.1.min.js"></script>
		<script src="assets/lib/3.js"></script>
		<script src="assets/lib/PointerLockControls.js"></script>
		<script src="assets/lib/stats.min.js"></script>
		<script src="assets/lib/dat.gui.js"></script>
		<script src="assets/scripts/rafShim.js"></script>
		<script src="assets/scripts/world.js"></script>
		<script src="assets/scripts/geometry.js"></script>
		<script src="assets/scripts/camera.js"></script>
		<script src="assets/scripts/player.js"></script>
		<script src="assets/scripts/keyboard.js"></script>
		<script src="assets/scripts/state.js"></script>
		<script src="assets/scripts/debug.js"></script>
		<script src="assets/scripts/GUI.js"></script>

		<footer>
			<script>

				window.onload = function() {
				
				world.init();
				world.defaults();	// Create default lights, etc -- TODO use dynamically loaded scene info
				world.renderer.setSize(world.viewportWidth, world.viewportHeight)	;
				cameraManager.init();
				debugObject.init();
				keyboard.init();
				player.init();
				stateManager.init();
				cameraManager.controls = new THREE.PointerLockControls( cameraManager.camera );
				world.scene.add( cameraManager.controls.getObject() );
				
				// POINTERLOCK TODO - this and potentially the keyboard object should be rolled into an input manager
				var havePointerLock = 'pointerLockElement' in document ||
				'moz	PointerLockElement' in document ||
				'webkitPointerLockElement' in document;
				if (havePointerLock){
					world.container.requestPointerLock = world.container.requestPointerLock ||
						world.container.mozRequestPointerLock ||
						world.container.webkitRequestPointerLock;
					// Ask the browser to lock the pointer
					jQuery(world.container).on('click', function(){ world.container.requestPointerLock(); cameraManager.controls.enabled=1; });
				}
				changeCallback = function(){
					if (document.pointerLockElement === world.container ||
						document.mozPointerLockElement === world.container ||
						document.webkitPointerLockElement === world.container) {
						document.addEventListener("mousemove", this.moveCallback, false);
					} else {
						document.removeEventListener("mousemove", this.moveCallback, false);
					}
				};
				document.addEventListener('pointerlockchange', changeCallback, false);
				document.addEventListener('mozpointerlockchange', changeCallback, false);
				document.addEventListener('webkitpointerlockchange', changeCallback, false);
				document.addEventListener("mousemove", this.moveCallback, false);
				
				// Setup the game states
				// TODO - Integration with manager? This is part of an event queue push/pop scheme 
				var newState={
					name:"new state name",
					stateCode: 1,
					before: function(){ alert('before'); },
					after: function(){ alert('after'); }
				};
				var newState2={
					name:"another state",
					stateCode: 2,
					before: function(){ alert('before!!!!!!!!!!!!!'); },
					after: function(){ alert('after!!!!!!!!!!!!!'); }
				};
				stateManager.addState(newState);
				stateManager.addState(newState2);
				
				world.obstacles = [];
				cameraManager.camera.position.y = -8;	// TODO debug
				var ssmod = geometryManager.loadModelJSON('assets/models/scene.js');

								
				// Animation loop /////////////////////////////////////////////////////////////////////////////////
				(function animloop(){ 
				
					requestAnimFrame(animloop);
					var timedelta = world.gameClock.getDelta();
					// Pointer lock update
					player.collisionCheck();	// Camera collision check
					cameraManager.controls.update(timedelta);
					// Update fps / stats
					debugObject.stats.update();

					// Render and get another frame
					world.renderer.render(world.scene, cameraManager.camera);
				})();
			};
			</script>
		</footer>
		
	</body>
  
</html>

